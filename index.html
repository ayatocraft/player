<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stable Music Player</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:system-ui;height:100vh}
.app{display:flex;height:100%}
.player{flex:2;padding:20px;position:relative}
.player::before{
  content:"";position:absolute;inset:0;
  background:var(--bg);background-size:cover;
  filter:blur(30px) brightness(.55);
  transform:scale(1.2)
}
.player-content{position:relative}
.track-info{display:flex;gap:14px;align-items:center}
.cover{width:110px;height:110px;border-radius:18px;object-fit:cover;background:#222}
#waveform{margin-top:20px}
#seek{width:100%;margin-top:10px}
.controls{display:flex;gap:12px;margin-top:14px}
button{border:none;border-radius:999px;padding:12px 18px;font-size:16px;cursor:pointer}
.list{flex:1;background:#111;display:flex;flex-direction:column}
.tracks{flex:1;overflow:auto}
.track{display:flex;gap:10px;align-items:center;padding:12px;cursor:pointer}
.track:hover{background:#222}
.track img{width:46px;height:46px;border-radius:10px}
.track .meta{flex:1}
.track small{opacity:.6}
.del{cursor:pointer;color:#f55;font-size:18px}

@media(max-width:768px){
  .app{flex-direction:column}
  .list{max-height:45vh}
}
</style>
</head>

<body>
<div class="app">

<div class="player" id="player">
  <div class="player-content">
    <button id="loadBtn">üìÇ Èü≥Ê•Ω„ÇíË™≠„ÅøËæº„ÇÄÔºàZIPÂèØÔºâ</button>
   <input
  type="file"
  id="fileInput"
  multiple
>



    <div class="track-info">
      <img id="cover" class="cover">
      <div>
        <h2 id="title">Êõ≤Âêç</h2>
        <p id="artist">„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà</p>
      </div>
    </div>

    <div id="waveform"></div>
    <input type="range" id="seek" min="0" max="100" value="0">

    <div class="controls">
      <button id="prevBtn">‚èÆ</button>
      <button id="playBtn">‚ñ∂ / ‚è∏</button>
      <button id="nextBtn">‚è≠</button>
    </div>
  </div>
</div>

<div class="list">
  <div class="tracks" id="list"></div>
</div>

</div>

<script>
/* ===== DOM ===== */
const loadBtn = document.getElementById("loadBtn");
const fileInput = document.getElementById("fileInput");
const list = document.getElementById("list");
const cover = document.getElementById("cover");
const titleEl = document.getElementById("title");
const artistEl = document.getElementById("artist");
const player = document.getElementById("player");
const seek = document.getElementById("seek");
const playBtn = document.getElementById("playBtn");
const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");

/* ===== IndexedDB ===== */
let db;
const dbReq = indexedDB.open("music-db",1);
dbReq.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("tracks",{keyPath:"id",autoIncrement:true});
};
dbReq.onsuccess=e=>{
  db=e.target.result;
  loadFromDB();
};

/* ===== State ===== */
let tracks=[], current=-1;

/* ===== WaveSurfer ===== */
const wave = WaveSurfer.create({
  container:"#waveform",
  waveColor:"#666",
  progressColor:"#fff",
  height:90,
  backend:"MediaElement"
});
const mediaEl = wave.getMediaElement();

/* ===== Load ===== */
loadBtn.onclick = ()=>fileInput.click();

fileInput.addEventListener("change", async (e) => {
  const files = Array.from(e.target.files);

  for (const file of files) {
    if (file.name.toLowerCase().endsWith(".zip")) {
      await loadZip(file);
    } else if (file.type.startsWith("audio/")) {
      await addAudioFile(file);
    }
  }

  fileInput.value = ""; // iOSÂØæÁ≠ñÔºöÂÜçÈÅ∏Êäû„Åß„Åç„Çã„Çà„ÅÜ„Å´
});


/* ===== Track Add ===== */
function addTrack(file,name){
  jsmediatags.read(file,{
    onSuccess:t=>{
      saveTrack({
        title:t.tags.title||name,
        artist:t.tags.artist||"",
        art:t.tags.picture
          ? new Blob([new Uint8Array(t.tags.picture.data)])
          : null,
        file
      });
    },
    onError:()=>saveTrack({title:name,artist:"",art:null,file})
  });
}

/* ===== DB ===== */
function saveTrack(data){
  const tx=db.transaction("tracks","readwrite");
  tx.objectStore("tracks").add(data);
  tx.oncomplete=loadFromDB;
}

function loadFromDB(){
  tracks=[];
  const tx=db.transaction("tracks","readonly");
  tx.objectStore("tracks").openCursor().onsuccess=e=>{
    const c=e.target.result;
    if(!c){ render(); return; }
    const t=c.value;
    tracks.push({
      file:t.file,
      title:t.title,
      artist:t.artist,
      art:t.art ? URL.createObjectURL(t.art) : ""
    });
    c.continue();
  };
}

/* ===== Render ===== */
function render(){
  list.innerHTML="";
  tracks.forEach((t,i)=>{
    const d=document.createElement("div");
    d.className="track";
    d.innerHTML=`
      <img src="${t.art}">
      <div class="meta"><div>${t.title}</div><small>${t.artist}</small></div>
      <div class="del">‚úñ</div>`;
    d.onclick=()=>play(i);
    d.querySelector(".del").onclick=e=>{
      e.stopPropagation();
      const tx=db.transaction("tracks","readwrite");
      tx.objectStore("tracks").delete(i+1);
      tx.oncomplete=loadFromDB;
    };
    list.appendChild(d);
  });
}

/* ===== Play ===== */
function play(i){
  current=i;
  const t=tracks[i];
  wave.load(URL.createObjectURL(t.file));
  titleEl.textContent=t.title;
  artistEl.textContent=t.artist;
  cover.src=t.art;
  player.style.setProperty("--bg",`url(${t.art})`);
  wave.once("ready",()=>wave.play());

  if("mediaSession" in navigator){
    navigator.mediaSession.metadata=new MediaMetadata({
      title:t.title,
      artist:t.artist,
      artwork:t.art?[{src:t.art,sizes:"512x512"}]:[]
    });
  }
}

/* ===== Auto Next ===== */
function autoNext(){
  if(current+1<tracks.length) play(current+1);
}
wave.on("finish",autoNext);
mediaEl.addEventListener("ended",autoNext);

/* ===== Controls ===== */
playBtn.onclick=()=>wave.playPause();
nextBtn.onclick=()=>current+1<tracks.length&&play(current+1);
prevBtn.onclick=()=>current>0&&play(current-1);

/* ===== Seek ===== */
mediaEl.addEventListener("timeupdate",()=>{
  if(mediaEl.duration){
    seek.value=(mediaEl.currentTime/mediaEl.duration)*100;
  }
});
seek.oninput=()=>mediaEl.currentTime=(seek.value/100)*mediaEl.duration;

/* ===== OS Media Control ===== */
if("mediaSession" in navigator){
  navigator.mediaSession.setActionHandler("play",()=>wave.play());
  navigator.mediaSession.setActionHandler("pause",()=>wave.pause());
  navigator.mediaSession.setActionHandler("nexttrack",autoNext);
  navigator.mediaSession.setActionHandler("previoustrack",()=>current>0&&play(current-1));
}
</script>
</body>
</html>
