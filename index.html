<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Stable Music Player</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:system-ui;height:100vh}
.app{display:flex;height:100%}
.player{flex:2;padding:24px;position:relative}
.player::before{
  content:"";position:absolute;inset:0;
  background:var(--bg);background-size:cover;
  filter:blur(30px) brightness(.55);
  transform:scale(1.2)
}
.player-content{position:relative}
.track-info{display:flex;gap:16px;align-items:center}
.cover{width:120px;height:120px;border-radius:18px;object-fit:cover;background:#222}
#waveform{margin-top:24px}
#seek{width:100%;margin-top:12px}
.controls{display:flex;gap:10px;margin-top:14px}
button{border:none;border-radius:999px;padding:10px 16px;cursor:pointer}
.list{flex:1;background:#111;display:flex;flex-direction:column}
.tracks{flex:1;overflow:auto}
.track{display:flex;gap:10px;align-items:center;padding:10px;cursor:pointer}
.track:hover{background:#222}
.track img{width:44px;height:44px;border-radius:8px}
.track .meta{flex:1}
.track small{opacity:.6}
.del{cursor:pointer;color:#f55}
.bottom-controls{
  padding:12px;border-top:1px solid #222;
  display:flex;gap:8px;flex-wrap:wrap
}
.toggle.active{background:#4af;color:#000}
</style>
</head>

<body>
<div class="app">

<div class="player" id="player">
  <div class="player-content">
    <button id="loadBtn">ğŸ“‚ éŸ³æ¥½ã‚’èª­ã¿è¾¼ã‚€ï¼ˆZIPå¯ï¼‰</button>
    <input id="fileInput" type="file" accept=".zip,audio/*" multiple hidden>

    <div class="track-info">
      <img id="cover" class="cover">
      <div>
        <h2 id="title">æ›²å</h2>
        <p id="artist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</p>
      </div>
    </div>

    <div id="waveform"></div>
    <input type="range" id="seek" min="0" max="100" value="0">

    <div class="controls">
      <button id="prevBtn">â®</button>
      <button id="playBtn">â–¶ / â¸</button>
      <button id="nextBtn">â­</button>
    </div>
  </div>
</div>

<div class="list">
  <div class="tracks" id="list"></div>
  <div class="bottom-controls">
    <button class="toggle" id="loopBtn">ä½¿ç”¨ä¸å¯Ã—</button>
    <button class="toggle" id="liveBtn">ä½¿ç”¨ä¸å¯Ã—</button>
    <button class="toggle" id="spatialBtn">ä½¿ç”¨ä¸å¯Ã—</button>
  </div>
</div>

</div>

<script>
/* ========= State ========= */
let tracks=[], current=-1, loop=false;
let audioCtx=null, source=null, convolver=null, panner=null;

/* ========= WaveSurfer ========= */
const wave = WaveSurfer.create({
  container:"#waveform",
  waveColor:"#666",
  progressColor:"#fff",
  height:90,
  backend:"MediaElement"
});

/* ========= Elements ========= */
const list=document.getElementById("list");
const cover=document.getElementById("cover");
const titleEl=document.getElementById("title");
const artistEl=document.getElementById("artist");
const player=document.getElementById("player");
const seek=document.getElementById("seek");

/* ========= Load ========= */
loadBtn.onclick = () => fileInput.click();

fileInput.onchange = async e => {
  for(const f of e.target.files){
    if(f.name.endsWith(".zip")){
      const zip=await JSZip.loadAsync(f);
      for(const z of Object.values(zip.files)){
        if(!z.dir && /\.(mp3|wav|ogg|m4a)$/i.test(z.name)){
          addTrack(await z.async("blob"),z.name);
        }
      }
    }else addTrack(f,f.name);
  }
};

function addTrack(file,name){
  jsmediatags.read(file,{
    onSuccess:t=>{
      tracks.push({
        file,
        title:t.tags.title||name,
        artist:t.tags.artist||"",
        art:t.tags.picture
          ? URL.createObjectURL(new Blob([new Uint8Array(t.tags.picture.data)]))
          : ""
      });
      render();
    },
    onError:()=>{tracks.push({file,title:name,artist:"",art:""});render();}
  });
}

/* ========= Render ========= */
function render(){
  list.innerHTML="";
  tracks.forEach((t,i)=>{
    const d=document.createElement("div");
    d.className="track";
    d.innerHTML=`
      <img src="${t.art}">
      <div class="meta"><div>${t.title}</div><small>${t.artist}</small></div>
      <div class="del">âœ–</div>`;
    d.onclick=()=>play(i);
    d.querySelector(".del").onclick=e=>{
      e.stopPropagation();
      tracks.splice(i,1);
      if(current===i){wave.stop();current=-1;}
      render();
    };
    list.appendChild(d);
  });
}

/* ========= Audio Graph ========= */
function ensureAudio(){
  if(audioCtx) return;
  audioCtx=new AudioContext();
  source=audioCtx.createMediaElementSource(wave.backend.media);
  panner=audioCtx.createStereoPanner();
  convolver=audioCtx.createConvolver();
  source.connect(panner).connect(convolver).connect(audioCtx.destination);
}

/* ========= Play ========= */
function play(i){
  ensureAudio();
  current=i;
  const t=tracks[i];
  wave.load(URL.createObjectURL(t.file));
  titleEl.textContent=t.title;
  artistEl.textContent=t.artist;
  cover.src=t.art;
  player.style.setProperty("--bg",`url(${t.art})`);
  wave.once("ready",()=>wave.play());

  if(navigator.mediaSession){
    navigator.mediaSession.metadata=new MediaMetadata({
      title:t.title,artist:t.artist,
      artwork:[{src:t.art,sizes:"512x512"}]
    });
    navigator.mediaSession.setActionHandler("nexttrack",next);
    navigator.mediaSession.setActionHandler("previoustrack",prev);
    navigator.mediaSession.setActionHandler("play",()=>wave.play());
    navigator.mediaSession.setActionHandler("pause",()=>wave.pause());
  }
}

/* ========= Controls ========= */
playBtn.onclick=()=>wave.playPause();
nextBtn.onclick=next;
prevBtn.onclick=prev;

function next(){
  if(current+1<tracks.length) play(current+1);
  else if(loop) play(0);
}
function prev(){ if(current>0) play(current-1); }

/* ========= Seek ========= */
wave.on("audioprocess",()=>{
  seek.value=(wave.getCurrentTime()/wave.getDuration())*100||0;
});
seek.oninput=()=>wave.seekTo(seek.value/100);

/* ========= End ========= */
wave.on("finish",()=>{ if(loop||current+1<tracks.length) next(); });

/* ========= Toggles ========= */
loopBtn.onclick=()=>loopBtn.classList.toggle("active",loop=!loop);
liveBtn.onclick=()=>liveBtn.classList.toggle("active");
spatialBtn.onclick=()=>spatialBtn.classList.toggle("active");
</script>
</body>
</html>
