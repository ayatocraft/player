<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Stable Music Player</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:system-ui;height:100vh}
.app{display:flex;height:100%}
.player{flex:2;padding:24px;position:relative}
.player::before{
  content:"";position:absolute;inset:0;
  background:var(--bg);background-size:cover;
  filter:blur(30px) brightness(.55);
  transform:scale(1.2)
}
.player-content{position:relative}
.track-info{display:flex;gap:16px;align-items:center}
.cover{width:120px;height:120px;border-radius:18px;object-fit:cover;background:#222}
#waveform{margin-top:24px}
#seek{width:100%;margin-top:12px}
.controls{display:flex;gap:10px;margin-top:14px}
button{border:none;border-radius:999px;padding:10px 16px;cursor:pointer}
.list{flex:1;background:#111;display:flex;flex-direction:column}
.tracks{flex:1;overflow:auto}
.track{display:flex;gap:10px;align-items:center;padding:10px;cursor:pointer}
.track:hover{background:#222}
.track img{width:44px;height:44px;border-radius:8px}
.track .meta{flex:1}
.track small{opacity:.6}
.del{cursor:pointer;color:#f55}
</style>
</head>

<body>
<div class="app">

<div class="player" id="player">
  <div class="player-content">
    <button id="loadBtn">ğŸ“‚ éŸ³æ¥½ã‚’èª­ã¿è¾¼ã‚€ï¼ˆZIPå¯ï¼‰</button>
    <!-- âœ… acceptå®Œå…¨å‰Šé™¤ï¼ˆiOSå¯¾ç­–ï¼‰ -->
    <input id="fileInput" type="file" multiple hidden>

    <div class="track-info">
      <img id="cover" class="cover">
      <div>
        <h2 id="title">æ›²å</h2>
        <p id="artist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</p>
      </div>
    </div>

    <div id="waveform"></div>
    <input type="range" id="seek" min="0" max="100" value="0">

    <div class="controls">
      <button id="prevBtn">â®</button>
      <button id="playBtn">â–¶ / â¸</button>
      <button id="nextBtn">â­</button>
    </div>
  </div>
</div>

<div class="list">
  <div class="tracks" id="list"></div>
</div>

</div>

<script>
/* ========= DOM ========= */
const loadBtn = document.getElementById("loadBtn");
const fileInput = document.getElementById("fileInput");
const list = document.getElementById("list");
const cover = document.getElementById("cover");
const titleEl = document.getElementById("title");
const artistEl = document.getElementById("artist");
const player = document.getElementById("player");
const seek = document.getElementById("seek");
const playBtn = document.getElementById("playBtn");
const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");

/* ========= IndexedDB ========= */
let db;
const req = indexedDB.open("music-db", 1);
req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("tracks", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = e => {
  db = e.target.result;
  loadFromDB();
};

/* ========= State ========= */
let tracks = [];
let current = -1;

/* ========= WaveSurfer ========= */
const wave = WaveSurfer.create({
  container: "#waveform",
  waveColor: "#666",
  progressColor: "#fff",
  height: 90,
  backend: "MediaElement"
});

/* ========= File Load ========= */
loadBtn.onclick = () => fileInput.click();

fileInput.onchange = async e => {
  for (const f of e.target.files) {
    if (f.name.toLowerCase().endsWith(".zip")) {
      const zip = await JSZip.loadAsync(f);
      for (const z of Object.values(zip.files)) {
        if (!z.dir && /\.(mp3|wav|ogg|m4a)$/i.test(z.name)) {
          addTrack(await z.async("blob"), z.name);
        }
      }
    } else if (f.type.startsWith("audio/")) {
      addTrack(f, f.name);
    }
  }
  fileInput.value = ""; // âœ… iOSå†é¸æŠå¯¾ç­–
};

/* ========= Track Add ========= */
function addTrack(file, name) {
  jsmediatags.read(file, {
    onSuccess: t => {
      saveTrack({
        title: t.tags.title || name,
        artist: t.tags.artist || "",
        art: t.tags.picture
          ? new Blob([new Uint8Array(t.tags.picture.data)])
          : null,
        file
      });
    },
    onError: () => saveTrack({ title: name, artist: "", art: null, file })
  });
}

function saveTrack(data) {
  const tx = db.transaction("tracks", "readwrite");
  tx.objectStore("tracks").add(data);
  tx.oncomplete = loadFromDB;
}

/* ========= Load ========= */
function loadFromDB() {
  tracks = [];
  const tx = db.transaction("tracks", "readonly");
  tx.objectStore("tracks").openCursor().onsuccess = e => {
    const c = e.target.result;
    if (!c) { render(); return; }
    const t = c.value;
    tracks.push({
      file: t.file,
      title: t.title,
      artist: t.artist,
      art: t.art ? URL.createObjectURL(t.art) : ""
    });
    c.continue();
  };
}

/* ========= UI ========= */
function render() {
  list.innerHTML = "";
  tracks.forEach((t, i) => {
    const d = document.createElement("div");
    d.className = "track";
    d.innerHTML = `
      <img src="${t.art}">
      <div class="meta"><div>${t.title}</div><small>${t.artist}</small></div>
      <div class="del">âœ–</div>`;
    d.onclick = () => play(i);
    d.querySelector(".del").onclick = e => {
      e.stopPropagation();
      const tx = db.transaction("tracks", "readwrite");
      tx.objectStore("tracks").delete(i + 1);
      tx.oncomplete = loadFromDB;
    };
    list.appendChild(d);
  });
}

/* ========= Play ========= */
function play(i) {
  current = i;
  const t = tracks[i];
  wave.load(URL.createObjectURL(t.file));
  titleEl.textContent = t.title;
  artistEl.textContent = t.artist;
  cover.src = t.art;
  player.style.setProperty("--bg", `url(${t.art})`);
  wave.once("ready", () => wave.play());
}

/* ========= Controls ========= */
playBtn.onclick = () => wave.playPause();
nextBtn.onclick = () => current + 1 < tracks.length && play(current + 1);
prevBtn.onclick = () => current > 0 && play(current - 1);

/* âœ… æ›²çµ‚äº† â†’ è‡ªå‹•æ¬¡æ›² */
wave.on("finish", () => current + 1 < tracks.length && play(current + 1));

/* ========= Seek ========= */
wave.on("audioprocess", () => {
  if (wave.getDuration()) {
    seek.value = (wave.getCurrentTime() / wave.getDuration()) * 100;
  }
});
seek.oninput = () => wave.seekTo(seek.value / 100);
</script>
</body>
</html>
