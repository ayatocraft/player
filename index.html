<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.16.0/Sortable.min.js"></script>

<style>
:root{
  --bg:#070707;
  --panel:#0f0f10;
  --muted:#bfbfbf;
  --accent:#6ad;
}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Segoe UI,Helvetica,Arial;}
.container{display:grid;grid-template-columns:1fr 320px;gap:16px;height:100vh;padding:18px;box-sizing:border-box;}
.main{border-radius:12px;padding:18px;position:relative;overflow:hidden;}
#bg{position:absolute;inset:0;filter:blur(30px) brightness(.45);transform:scale(1.05);}
.content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:12px;}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
input[type=range]{width:420px;}
canvas{width:100%;height:220px;border-radius:8px;}
.playlist-panel{background:var(--panel);padding:12px;border-radius:12px;display:flex;flex-direction:column;}
.small-controls{display:flex;gap:8px;flex-wrap:wrap;}

.toggle{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
}
.toggle input{accent-color:var(--accent);}

@media(max-width:900px){
  .container{grid-template-columns:1fr;}
  input[type=range]{width:220px;}
}
</style>
</head>
<body>

<div class="container">
<div class="main">
<img id="bg">
<div class="content">
<h1>ğŸµéŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h1>

<img id="albumThumb" width="96">
<div id="trackTitle">æ›²ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
<div id="trackSub" class="muted">â€”</div>

<div class="controls">
<button id="prevBtn">â®</button>
<button id="playBtn">â–¶</button>
<button id="nextBtn">â­</button>
<input id="seek" type="range" min="0" max="100" step="0.1">
<span id="time" class="muted">0:00 / 0:00</span>
</div>

<canvas id="spectrum"></canvas>
</div>
</div>

<aside class="playlist-panel">
<input id="fileInput" type="file" multiple>
<button id="openBtn">èª­ã¿è¾¼ã¿</button>

<div id="plist"></div>

<div class="small-controls">
<label class="toggle">
<input type="checkbox" id="liveToggle"> ğŸ¤ ãƒ©ã‚¤ãƒ–éŸ³éŸ¿
</label>
<label class="toggle">
<input type="checkbox" id="spatialToggle"> ğŸ§ ç«‹ä½“éŸ³éŸ¿
</label>
</div>
</aside>
</div>

<script>
let audio=new Audio();
let audioCtx,source,analyser,panner,convolver;
let playlist=[],current=-1,playing=false;

const playBtn=playBtn=document.getElementById('playBtn');

function initAudio(){
  if(audioCtx) return;
  audioCtx=new AudioContext();
  source=audioCtx.createMediaElementSource(audio);
  analyser=audioCtx.createAnalyser();
  panner=audioCtx.createStereoPanner();
  convolver=audioCtx.createConvolver();

  source.connect(analyser);
  analyser.connect(panner);
  panner.connect(convolver);
  convolver.connect(audioCtx.destination);
}

document.getElementById('liveToggle').onchange=e=>{
  convolver.buffer=e.target.checked?createImpulse():null;
};

document.getElementById('spatialToggle').onchange=e=>{
  panner.pan.value=e.target.checked?0.6:0;
};

function createImpulse(){
  const rate=audioCtx.sampleRate;
  const buf=audioCtx.createBuffer(2,rate,rate);
  for(let c=0;c<2;c++){
    let d=buf.getChannelData(c);
    for(let i=0;i<d.length;i++){
      d[i]=(Math.random()*2-1)*(1-i/d.length);
    }
  }
  return buf;
}

async function play(){
  initAudio();
  await audioCtx.resume();
  await audio.play();
  playing=true;
  playBtn.textContent="â¸";
  updateMediaSession();
}

function pause(){
  audio.pause();
  playing=false;
  playBtn.textContent="â–¶";
}

playBtn.onclick=()=>playing?pause():play();

function updateMediaSession(){
  if(!navigator.mediaSession) return;
  const t=playlist[current];
  navigator.mediaSession.metadata=new MediaMetadata({
    title:t.name,
    artist:t.artist||"",
    artwork:[{src:t.thumbDataUrl||"",sizes:"512x512",type:"image/png"}]
  });
  navigator.mediaSession.setActionHandler('play',play);
  navigator.mediaSession.setActionHandler('pause',pause);
  navigator.mediaSession.setActionHandler('nexttrack',()=>load(current+1));
  navigator.mediaSession.setActionHandler('previoustrack',()=>load(current-1));
}
</script>
</body>
</html>
